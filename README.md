# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- src/ — исходные файлы проекта
- src/components/ — папка с JS компонентами
- src/components/base/ — папка с базовым кодом

Важные файлы:
- src/pages/index.html — HTML-файл главной страницы
- src/types/index.ts — файл с типами
- src/index.ts — точка входа приложения
- src/scss/styles.scss — корневой файл стилей
- src/utils/constants.ts — файл с константами
- src/utils/utils.ts — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```
# Архитектура приложения

**MVP**
- Model (Модель) работает с данными, проводит вычисления и руководит всеми бизнес-процессами.
- View (Вид или представление) показывает пользователю интерфейс и данные из модели.
- Presenter (Представитель) служит прослойкой между моделью и видом.

## Описание проекта
Этот проект реализован с использованием архитектурного шаблона MVP (Model-View-Presenter). В проекте используется TypeScript для типизации данных и классов. Ниже описаны основные типы данных, модели, классы представления и события, используемые в проекте.

## Данные и типы данных, используемые в приложении

### CategoryType
Тип, описывающий категории товара.

```
- `другое`
- `софт-скил`
- `дополнительное`
- `кнопка`
- `хард-скил`
```
Данные карточки товара

```
interface IProduct {
    id: string;
	description: string;
	image: string;
	title: string;
	category: ProductCategory;
	price: number | null;
}
```

Ошибки в форме
```
type FormErrors = {
	email?: string;
	phone?: string;
	address?: string;
	payment?: string;
}
```

Интерфейс для данных заказа

```
interface IOrder {
    address: string;
	phone: string;
	payment: string;
	email: string;
	total: number | null;
	items: string[]
}
```

Результат заказа
```
interface IOrderResult {
    id: string
    total: number | null;
    error: string
}
```

Данные карточки, используемые в модальном окне корзины

```
type TBasket = Pick<IProduct, 'id' | 'title' | 'price'>
```

## Архитектура приложения

Код приложения разделёна на слои согласно парадигме MVP:
- слой представления, отвечает за отображение данных на странице,
- слой данных, отвечает за хранение и изменение данных,
- презентер, отвечает за связь представления в данных.

### Базовый код

#### Класс Api 
Содержит в себе базовую логику отправки запросво. В конструкотор передаётся базовый адрес сервера и опциональный объект с заголовками запросов.
Методы:
- `get` - выполняет GET запрос на переданный в параметрах ендпоинт и возращает промис с объектом, которым ответил сервер
- `post` - принимает объект с данными, которые будут переданы в JSON в теле запроса, и отправляет эти данные на ендпоинт переданный как параметр при вызове метода. По умолчанию выполняется `POST` запрос, но метод запроса может быть переопределён заданием третьего параметра при вызове.

#### Класс EventEmitter
Брокер событий позволяет отправлять события и подписываться на события, происходящие в системе. Класс используется в презентере для обработки событий и в слоях приложения для генерации событий.
Основные метода, реализуемые классом описаны интерефейсом `IEvents`:
- `on` - подписка на событие 
- `emit` - инициализация события 
- `trigger` - возвращает функцию, при вызове котороой инициализируется требуемое в параметрах событие

#### Класс Component

Базовый класс для представлений. Работает с дженериками. В конструкторе принимает элемент разметки,
который будет заполняться данными из модели.

Основные методы:

- `toggleClass(element: HTMLElement, className: string, force?: boolean)` - тогл класса для элемента.
  Параметры: элемент разметки, класс для тогла, необязательный параметр
  типа boolean для переключения тогла только в одном направлении
- `setText(element: HTMLElement, value: unknown)` - установить текст элементу
- `setDisabled(element: HTMLElement, state: boolean)` - установить (снять) атрибут disabled.
  Параметры: элемент разметки, boolean флаг, в зависимости от которого будет устанавливаться или сниматься атрибут
- `setHidden(element: HTMLElement)` - скрыть элемент
- `setVisible(element: HTMLElement)` - показать элемент
- `setImage(element: HTMLImageElement, src: string, alt?: string)` - установить изображение элементу с альтернативным
  текстом (если он передан)
- `render(data?: Partial<T>)` - возвращает элемент с заполненными данными. Принимает необязательный параметр data с
  полями указанного ранее типа данных. (данные могут быть частичными)

#### Класс Modal

Родительский класс модели данных, работает с дженериками

Конструктор:

- `constructor(data: Partial<T>, protected events: IEvents)`  - принимает данные выбранного нами типа(возможно неполные)
  и экземпляр `IEvents` для работы с событиями

Основные методы:

- `emitChanges(event: string, payload?: object)` - сообщает всем, что модель изменилась. Принимает на вход событие и
  данные, которые изменились

### Слой данных

#### Класс AppData

Реализует работу с моделью приложения. Суть класса, как и всего слоя, заключается в том, чтобы хранить информацию обо всем приложении, его состояниях и производить вычисления данных внутри. \
Расширяет класс Model
Все поля приватные, доступ через методы \
В полях класса хранятся следующие данные:

- products: IProduct[] - массив объектов продуктов (товаров)
- basket: IProduct[] - массив товаров в корзине
- order: IOrder - заказ
- selectedProduct: string | null - id товара для отображения в модальном окне
- formErrors: FormErrors = {}

Также класс предоставляет набор методов для взаимодействия с этими данными.

- `setProducts` - получаем товары для главной страницы
- `getProducts` - возвращает товары
- `selectProduct` - выбор продукта для отображения в модальном окне
- `getBasket` - возвращает корзину
- `addProductToBasket` - добавление товара в корзину
- `removeProductFromBasket` - удаление товара из корзины
- `getTotalPrice` - получение стоимости всей корзины
- `clearBasket` - очищаем корзину
- `getOrder` - возвращаем заказ
- `isFirstFormFill` - проверка на заполнение первой формы
- `clearOrder` - очищаем текущий заказ
- `setOrderField` - записываем значение в поле заказа
- `validateOrder` - валидация полей заказа и установка значений ошибок, если они есть

### Классы представлений
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных. 

#### Интерфейс IModalData

Представляет содержимое модального окна

```
interface IModalData {
  content: HTMLElement - содержимое модального окна
}
```

#### Класс Modal

Общий класс для модальных окон

```
class Modal extends Component<IModalData> {
  closeButton: HTMLButtonElement - кнопка закрытия
  content: HTMLElement - содержимое модального окна
}
```

Конструктор принимает на вход HTMLElement и IEvents для работы с событиями

Основные методы:

- `set content` - установить содержимое модального окна
- `open` - открыть модальное окно, добавляя класс видимости к container и эмитируя событие modal:open.
- `close` - закрыть модальное окно, удаляя класс видимости из container, очищает содержимое и эмитирует событие modal:
  close.

#### Класс Form

Общий класс для работы с формами, расширяет Component
```
class Form<T> extends Component<IFormState> {
    protected _submit: HTMLButtonElement;
    protected _errors: HTMLElement;
}
```

Основные методы:

- `onInputChange` - изменение значений полей ввода
- `set valid` - проверка валидации
- `set errors` - установка текстов ошибок

#### Класс BasketView

Отображение корзины в модальном окне, расширяет Modal

```
class BasketView extends Modal {
  private basket: IProduct[] - список продуктов в корзине
  private total: number | null - сумма покупок
}
```

Основные методы

- `set basket` - установить список продуктов в корзине
- `set total` - установить общую сумму продуктов в корзине

#### Класс ProductView
Отображение продукта на главной странице

```
class ProductView extends Component<IProduct>{
    private _image: HTMLImageElement;
    private _title: HTMLElement;
    private _category: HTMLElement;
    private _price: HTMLElement;
    protected _button: HTMLButtonElement;
    private observers: ProductInBasketView[] = [];
}
```

#### Класс ProductViewModal
Отображение продукта в модальном окне

```
class ProductModalView extends Modal {
   private _description: HTMLElement;
}
```

#### Класс OrderFormView - отображение формы заказа

```
class OrderFormView extends Modal {
  private orderFields: Record<keyof IOrder, [value:string, error:string]> | null
  private buttonActive: Boolean
}
```

#### Класс OrderResultView
Отображение результата заказа. Расширяет Modal

```
class OrderResultView extends Modal {
  private description: string
  private title: string
}
```

Основные методы

- `set title` - установить заголовок
- `set description` - установить описание

# Коммуникационный слой

Отвечает за взаимодействие с сервером\
Все взаимодействие строится на работе с событиями

получаем данные -> генерируем события -> выполняем действия\
данные в модели изменяются -> генерируем событие -> выполняем действия

### Класс `LarekApi`

Принимает в конструктор экземпляр класса Api и предоставляет методы реализующие взаимодействие с бэкендом сервиса.

- `constructor()`

Реализует методы:
- `getProducts(): Promise<IProductList<IProduct>>` - загружает массив карточек с сервера 
- `createOrder(order: IOrder): Promise<IOrderResult>` - изменяет данные заказа на сервере

## Взаимодействие компонентов

Код, описывающий взаимодействие слоя представления и слоя данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

*Список всех событий, которые могут генерироваться в системе:*

- `products:changed` - изменение массива карточек
- `product:preview` - открытие модалки с товаром
- `userData:changed` - изменение данных пользователя при заполнении формы
- `basket:add-product` - добавление товара в корзину
- `basket:remove-product` - удаление товара из корзины
- `modal:close` - клик на иконку закрытия модального окна/клик на кнопку в модальном окне успешного заказа для перехода на главную
- `modal:open` - открытие модалки
- `basket:open` - открытие корзины пользователя
- `product:delete` - клик на иконку удаление товара из корзины
- `form:errors-changed` - показ(скрытие) ошибок формы
- `order:open` - открытие формы заказа
- `order:clear` - очистка формы заказа
- `form-userdata:submit` - клик на кнопку далее в модальном окне с данными пользователя
- `order: set_peyment-type` - выбор способа оплаты